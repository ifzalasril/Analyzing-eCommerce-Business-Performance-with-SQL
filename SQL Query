1. Monthly Active User per Year

SELECT 
	YEAR, 
	round(AVG(mau), 0) AS average_monthly_active_user
FROM (
	SELECT 
		date_part('year', o.order_purchase_timestamp) AS YEAR,
		date_part('month', o.order_purchase_timestamp) AS MONTH,
		COUNT(DISTINCT c.customer_unique_id) AS mau
	FROM orders o 
	JOIN customers c ON o.customer_id = c.customer_id
	GROUP BY YEAR, MONTH 
) subq
GROUP BY YEAR

2. New Customers
SELECT 
	date_part('year', first_purchase_time) AS YEAR,
	COUNT(1) AS new_customers
FROM (
	SELECT 
		c.customer_unique_id,
		MIN(o.order_purchase_timestamp) AS first_purchase_time
	FROM orders o 
	JOIN customers c ON c.customer_id = o.customer_id
	GROUP BY customer_unique_id
) subq
GROUP BY YEAR
ORDER BY YEAR
 
3. Repeating Customers

SELECT 
	YEAR, 
	COUNT(DISTINCT customer_unique_id) AS repeating_customers
FROM (
	SELECT 
		date_part('year', o.order_purchase_timestamp) AS YEAR,
		c.customer_unique_id,
		COUNT(1) AS purchase_frequency
	FROM orders o 
	JOIN customers c ON c.customer_id = o.customer_id
	GROUP BY YEAR, customer_unique_id
	HAVING COUNT(1) > 1
) subq
GROUP BY YEAR

4. Customer Average Orders

SELECT 
	YEAR, 
	ROUND(AVG(frequency_purchase),3) AS avg_orders_per_customers 
FROM (
	SELECT 
		date_part('year', o.order_purchase_timestamp) AS YEAR,
		c.customer_unique_id,
		COUNT(1) AS frequency_purchase
	FROM orders o 
	JOIN customers c ON c.customer_id = o.customer_id
	GROUP BY YEAR, customer_unique_id
) a
GROUP BY YEAR

5. Hasil Metrik
